<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Edit Aktivitas</title>
    <!-- <script>
      function previewImage(event) {
        const output = document.getElementById("newImagePreview");
        output.src = URL.createObjectURL(event.target.files[0]);
        output.style.display = "inline-block";
      }
    </script> -->
  </head>
  <body>
    <h1>Edit Aktivitas</h1>
    <form
      th:action="@{/aktivitas/edit}"
      th:object="${aktivitas}"
      method="post"
      enctype="multipart/form-data"
    >
      <input type="hidden" th:field="*{idAktivitas}" />

      <input type="hidden" th:field="*{satuanJarak}" />

      <label for="tanggal">Tanggal</label>
      <p id="tanggal" th:text="*{tanggalAktivitas}"></p>

      <label for="waktu">Waktu</label>
      <p id="waktu" th:text="*{formattedWaktuTempuh}"></p>

      <label for="judul">Judul</label>
      <input type="text" id="judul" th:field="*{judul}" />

      <label for="deskripsi">Deskripsi</label>
      <textarea id="deskripsi" th:field="*{deskripsi}"></textarea>

      <!-- Foto Lama -->
      <label>Foto Lama:</label>
      <div id="photoContainer">
        <div
          th:each="foto : ${aktivitas.urlFoto}"
          th:attr="data-photo-url=${foto}"
        >
          <div style="display: flex; align-items: center; margin-bottom: 10px">
            <img
              th:src="@{'/uploads/aktivitas/' + ${foto}}"
              style="max-width: 100px; max-height: 100px; margin-right: 10px"
            />
            <button
              type="button"
              th:attr="onclick=|deletePhoto('${foto}', event)|"
              style="
                background-color: red;
                color: white;
                border: none;
                cursor: pointer;
                padding: 5px 10px;
              "
            >
              Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Tambahkan Foto Baru -->
      <label for="foto">Tambah Foto Baru:</label>
      <input type="file" id="foto" name="foto" accept="image/*" multiple />
      <button
        type="button"
        onclick="uploadNewPhotos()"
        style="
          background-color: green;
          color: white;
          border: none;
          cursor: pointer;
          padding: 5px 10px;
        "
      >
        Simpan Foto
      </button>

      <button type="submit">Simpan</button>
    </form>

    <script>
      function deletePhoto(photoUrl, event) {
        if (event) {
          event.preventDefault();
        }
        // event.preventDefault(); // Mencegah refresh halaman
        if (confirm("Apakah Anda yakin ingin menghapus foto ini?")) {
          fetch(`/aktivitas/hapus-foto`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ urlFoto: photoUrl }),
          })
            .then((response) => {
              if (response.ok) {
                console.log("Foto berhasil dihapus:", photoUrl);

                // Hapus elemen foto dari DOM
                const photoElement = document.querySelector(
                  `div[data-photo-url="${photoUrl}"]`
                );
                if (photoElement) {
                  photoElement.remove();
                  console.log("Elemen berhasil dihapus dari DOM.");
                } else {
                  console.error(
                    `Elemen dengan data-photo-url="${photoUrl}" tidak ditemukan di DOM.`
                  );
                }
              } else {
                alert("Gagal menghapus foto di backend.");
              }
            })
            .catch(() =>
              alert("Terjadi kesalahan saat menghapus foto di backend.")
            );
        } else {
          console.log("Penghapusan foto dibatalkan.");
        }
      }

      function uploadNewPhotos() {
        const formData = new FormData();
        const files = document.getElementById("foto").files;

        // Cari elemen ID Aktivitas
        const idAktivitasInput = document.querySelector(
          'input[name="idAktivitas"]'
        );
        if (!idAktivitasInput) {
          console.error("Input untuk 'idAktivitas' tidak ditemukan.");
          alert("Terjadi kesalahan, ID Aktivitas tidak ditemukan.");
          return;
        }

        const idAktivitas = idAktivitasInput.value;

        // Tambahkan file dan ID Aktivitas ke FormData
        for (let file of files) {
          formData.append("foto", file);
        }
        formData.append("idAktivitas", idAktivitas);

        // Kirim permintaan ke backend
        fetch(`/aktivitas/upload-foto`, {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Gagal mengunggah foto");
            }
            return response.json();
          })
          .then((urls) => {
            // Tambahkan foto baru ke halaman
            const photoContainer = document.getElementById("photoContainer");

            urls.forEach((url) => {
              const newPhotoElement = document.createElement("div");
              newPhotoElement.setAttribute("data-photo-url", url);
              newPhotoElement.style.display = "flex";
              newPhotoElement.style.alignItems = "center";
              newPhotoElement.style.marginBottom = "10px";

              // Tambahkan timestamp unik ke URL untuk menghindari cache
              const timestamp = new Date().getTime();

              newPhotoElement.innerHTML = `
                    <img src="/uploads/aktivitas/${url}?t=${timestamp}" style="max-width: 100px; max-height: 100px; margin-right: 10px;" />
                    <button
                        style="background-color: red; color: white; border: none; cursor: pointer; padding: 5px 10px;"
                        onclick="deletePhoto('${url}', event)">Delete</button>
                `;
              photoContainer.appendChild(newPhotoElement);
            });
          })
          .catch((error) => {
            console.error(error);
            alert("Terjadi kesalahan saat mengunggah foto!");
          });
      }
    </script>
  </body>
</html>
